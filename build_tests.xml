<?xml version="1.0" encoding="UTF-8"?>
<project basedir="."  default="run-tests" name="Tests">

	<property name="encoding" value="UTF-8"/>

    <property name="src_tests" location="src_tests"/>

	<property name="build.home" location="build"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>

    <property name="docs" location="docs" />
    <property name="report.tests" location="${docs}/tests" />
    <property name="report.coverage" location="${report.tests}/coverage" />

    <property name="lib" location="lib" />

	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="off"/>
  	<property name="compile.optimize"    value="off"/>


    <target name="compile-tests"
    		description="Compile test code">
		<javac destdir="${build.home.webinf.classes}"
               extdirs="${lib}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
			   nowarn="true">
			<src path="${src_tests}"/>
		</javac>
    </target>

    <target name="run-tests"
    		description="Run all tests"
    		depends="compile-tests">
		<junit haltonfailure="false" printsummary="yes" dir="${build.home.webinf.classes}">
            <formatter type="plain" usefile="false"/>
            <batchtest fork="yes">
                <fileset dir="${src_tests}">
			<include name="**/*Website*Test.java"/>
		</fileset>
            </batchtest>
            <classpath>
                <pathelement path="${build.home.webinf.classes}"/>
                <fileset dir="${lib}">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
        </junit>
    </target>

	<!-- TODO: give class as an argument -->
    <target name="run-curricular-period-test"
    		description="Run CurricularPeriod Test"
    		depends="compile-tests">
		<junit haltonfailure="false" printsummary="yes" dir="${build.home.webinf.classes}">
            <formatter type="plain" usefile="false"/>
            <batchtest fork="yes">
                <fileset dir="${src_tests}">
				   	<include name="**/CurricularPeriodTest.java"/>
				</fileset>
            </batchtest>
            <classpath>
                <pathelement path="${build.home.webinf.classes}"/>
                <fileset dir="${lib}">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
        </junit>
    </target>
	
    <target name="report-tests"
    		description="Run all tests and generate a report"
    		depends="compile-tests">
    	<delete dir="${report.tests}"/>
    	<mkdir dir="${report.tests}"/>
		<junit haltonfailure="false" printsummary="yes" dir="${build.home.webinf.classes}">
            <formatter type="xml"/>
            <batchtest fork="yes" todir="${report.tests}">
                <fileset dir="${src_tests}">
				   	<include name="**/*Test.java"/>
				</fileset>
            </batchtest>
            <classpath>
                <pathelement path="${build.home.webinf.classes}"/>
                <fileset dir="${lib}">
                    <include name="*.jar"/>
                </fileset>
            </classpath>
        </junit>
    	<junitreport todir="${report.tests}">
    	  <fileset dir="${report.tests}">
    	    <include name="TEST-*.xml"/>
    	  </fileset>
    	  <report format="frames" todir="${report.tests}/html"/>
    	</junitreport>
    	<delete>
      	  <fileset dir="${report.tests}">
      	    <include name="TEST-*.xml"/>
      	  </fileset>    		
    	</delete>
    </target>


<taskdef name="instrument" classname="com.jcoverage.ant.InstrumentTask">
	<classpath>
            <fileset dir="${lib}">
                <include name="jcoverage.jar"/>
            </fileset>
        </classpath>
</taskdef>

<target name="instrument">
	<mkdir dir="${build.home.webinf.classes}"/>
	<instrument todir="${build.home.webinf.classes}/instrumented">
		<classpath>
                <pathelement path="${build.home.webinf.classes}"/>
                <fileset dir="${lib}">
                    <include name="*.jar"/>
                </fileset>
            </classpath>

		<fileset dir="${build.home.webinf.classes}">
			<include name="**/domain/**/*.class"/>
		</fileset>
	</instrument>
</target>

<target name="report-coverage">
	<report format="html" srcdir="${src.dir}" destdir="${report.coverage}"/>
</target>


</project>

