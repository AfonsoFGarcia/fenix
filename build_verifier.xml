<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="ojb2dmlVerifier" name="Compilation Scripts">

    <property environment="env"/>
	<property name="encoding" value="ISO-8859-1"/>	

	<property file="build.properties"/>

	<property name="config" location="config"/>

    <!-- Source code directories -->
    <property name="src" location="src"/>
    <property name="src_gen" location="src_gen"/>    
    <property name="src_tools" location="src_tools"/>

	<!-- Directories for compiled code -->
	<property name="build.home" location="build"/>
	<property name="build.home.temp" value="${build.home}/temp"/>
	<property name="build.home.temp.classes" value="${build.home.temp}/temp/classes"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>

	<!-- DML definition file -->
	<property name="dml.definition.file" value="${config}/domain_model.dml"/>

  <property name="analysis.subdir" value=""/>

    <!-- Directories with libraries (JARs) -->
    <property name="lib" location="lib" />

	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="off"/>
  	<property name="compile.optimize"    value="on"/>


  <target name="ojb2dmlVerifier"
          depends="analysis-compile"
          description="Verify DML mapping from OJB Mapping.">
    <java classname="pt.utl.ist.domain.DomainDMLOJBVerifier" fork="true">
      <classpath>
	<pathelement path="${build.home.temp.classes}"/>
	<pathelement path="${build.home.webinf.classes}"/>
	<fileset dir="${lib}">
	  <include name="**/*.jar"/>
	  <exclude name="**/berserk.jar"/>
	</fileset>
      </classpath>
    </java>
  </target>


  <target name="dml2ojbVerifier"
          depends="analysis-compile"
          description="Verify OJB mapping from DML Mapping.">
    <java classname="pt.utl.ist.domain.FindMissingOJBMappings" fork="true">
      <classpath>
	<pathelement path="${build.home.temp.classes}"/>
	<pathelement path="${build.home.webinf.classes}"/>
	<fileset dir="${lib}">
	  <include name="**/*.jar"/>
	  <exclude name="**/berserk.jar"/>
	</fileset>
      </classpath>
      <arg value="${dml.definition.file}"/>      
    </java>
  </target>


  <path id="classpath.analysis">
    <pathelement path="${build.home.temp.classes}"/>
    <fileset dir="${lib}">
      <include name="**/*.jar"/>
    </fileset>
  </path>

  <target name="ask-subdir" unless="analysis.subdir">
    <input message="Which subdirectory to analyze? "
           addproperty="analysis.subdir"/>
  </target>

  <target name="analysis-compile">
    <ant antfile="build_compile.xml" target="compile" />
    <ant antfile="build_codeGenerator.xml" target="compile" />
  </target>


  <target name="find-new-of-domain-objects"
          depends="analysis-compile"
          description="Report occurrences of domain object's allocations.">
    <java classname="pt.utl.ist.analysis.FindDomainObjectAllocations" fork="true">
      <classpath refid="classpath.analysis"/>
      <arg value="-d"/>
      <arg value="${dml.definition.file}"/>
      <arg value="-f"/>
      <arg value="${build.home.webinf.classes}/${analysis.subdir}"/>
      <arg value="-i"/>
      <arg value="net.sourceforge.fenixedu.persistenceTier.OJB.DomainAllocator"/>
      <arg value="-i"/>
      <arg value="net.sourceforge.fenixedu.domain.DomainFactory"/>
    </java>
  </target>

  <target name="find-casts-for-domain-objects"
          depends="analysis-compile"
          description="Report occurrences of casts to domain objects.">
    <java classname="pt.utl.ist.analysis.FindCastsToDomainObjects" fork="true">
      <classpath refid="classpath.analysis"/>
      <arg value="-d"/>
      <arg value="${dml.definition.file}"/>
      <arg value="-f"/>
      <arg value="${build.home.webinf.classes}/${analysis.subdir}"/>
      <arg value="-i"/>
      <arg value="net.sourceforge.fenixedu.domain.*_Base"/>
    </java>
  </target>

  <target name="find-instanceofs-domain-objects"
          depends="analysis-compile"
          description="Report occurrences of instanceofs domain objects.">
    <java classname="pt.utl.ist.analysis.FindInstanceofsDomainObjects" fork="true">
      <classpath refid="classpath.analysis"/>
      <arg value="-d"/>
      <arg value="${dml.definition.file}"/>
      <arg value="-f"/>
      <arg value="${build.home.webinf.classes}/${analysis.subdir}"/>
    </java>
  </target>

  <target name="find-setter-calls"
          depends="analysis-compile"
          description="Report occurrences of calls to setter methods.">
    <java classname="pt.utl.ist.analysis.FindSetCallsToDomainObjects" fork="true">
      <classpath refid="classpath.analysis"/>
      <arg value="-d"/>
      <arg value="${dml.definition.file}"/>
      <arg value="-f"/>
      <arg value="${build.home.webinf.classes}/${analysis.subdir}"/>
    </java>
  </target>

  <target name="find-setter-calls-with-no-previous-lock"
          depends="analysis-compile"
          description="Report occurrences of calls to setter methods.">
    <java classname="pt.utl.ist.analysis.FindSetCallsWithNoLockWrite" fork="true">
      <classpath refid="classpath.analysis"/>
      <arg value="-d"/>
      <arg value="${dml.definition.file}"/>
      <arg value="-f"/>
      <arg value="${build.home.webinf.classes}/${analysis.subdir}"/>
    </java>
  </target>

</project>
