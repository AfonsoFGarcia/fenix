<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." name="DataBase Utils">

	<property environment="env"/>
	<property name="encoding" value="ISO-8859-15"/>

	<property file="build.properties" />

	<property name="lib" location="lib" />

	<target name="set-properties-copy" if="institution.project"
	            description="Determine properties to use for build properties">
		<property name="build.home" location="build"/>
	</target>

	<target name="set-properties-inplace" unless="institution.project"
	            description="Determine properties to use for build properties">
		<property name="build.home" location="web"/>
	</target>

	<target name="set-properties" description="Determine properties to use for build properties"
	            depends="set-properties-copy, set-properties-inplace">
		<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
		<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>
		<property name="build.home.webinf.classes.meta.inf" value="${build.home.webinf.classes}/META-INF"/>
		<property name="build.home.webinf.conf" value="${build.home.webinf}/conf"/>
		<property name="build.home.webinf.libs" value="${build.home.webinf}/lib"/>
		<property name="build.home.webinf.lib" value="${build.home.webinf}/lib"/>
		<property name="build.home.jsp_gen_code" value="${build.home}/Jsp-Code"/>
		<property name="build.home.jsp_gen_code.classes" value="${build.home.jsp_gen_code}/classes"/>
		<property name="build.home.reports" value="${build.home.webinf.classes}/reports"/>
		<property name="dml.definition.file.completed" value="${build.home.webinf.classes}/domain_model.dml"/>
		<property name="build.home.xfire" value="${build.home.webinf.classes.meta.inf}/xfire" />
		<property name="build.home.temp" value="${build.home}/temp"/>
		<property name="build.home.temp.classes" value="${build.home.temp}/classes"/>

	</target>

	<target name="compile" depends="set-properties"
    		description="Compile tools">
		<ant antfile="build_compile.xml" target="compile-tools"/>
	</target>


	<target name="SQLCleaner"
    		description="Generate sql cleanup instructions for ACK_OPT_LOCK and useless stuff in indirection tables."
    		depends="compile">
		<java classname="pt.utl.ist.codeGenerator.SQLCleaner" fork="true">
			<arg value="etc/cleanup.sql"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

    <target name="SQLUpdateGenerator" depends="compile"
	        description="Generates possible sql instructions to be run on next deploy.">
		<java classname="pt.ist.fenixframework.pstm.repository.SQLUpdateGenerator" fork="true">
			<!--				jvmargs="-Xdebug -Xnoagent -Djava.compiler=NONE  -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y" -->
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg value="-charset"/>
			<arg value="latin1"/>
			<!-- arg value="-genDrops"/ -->
			<arg value="${db.alias}"/>
			<arg value="${db.user}"/>
			<arg value="${db.pass}"/>
			<arg value="${plugins}"/>
			<arg value="${build.home.webinf.classes}/domain_model.dml"/>
		</java>
	</target>

	<target name="CheckOids"
            depends="set-properties"
    		description="Checks that all OIDs are ok.">
		<java classname="pt.ist.fenixframework.pstm.repository.CheckOids" fork="true"
				jvmargs="-Xmx1024m">
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg value="${db.alias}"/>
			<arg value="${db.user}"/>
			<arg value="${db.pass}"/>
			<arg value="${build.home.webinf.classes}/domain_model.dml"/>
		</java>
	</target>

	<target name="pre-init-data-structure"
    		description="Generate sql schema for fenix database."
    		depends="compile">
		<java classname="pt.utl.ist.codeGenerator.database.PreInitDataStructure" fork="true"
				jvmargs="-Xmx1024m -Dfile.encoding=iso8859-1">
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	
	<target name="initialize-database"
    		description="Generate sql schema for fenix database."
    		depends="compile">
		<java classname="pt.utl.ist.codeGenerator.database.DataInitializer" fork="true"
				jvmargs="-Xmx1024m -Dfile.encoding=iso8859-1">
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="prepare-full-run-file" depends="set-properties"
    		description="Generates a single run file for upgrading database.">
		<java classname="pt.utl.ist.fenix.tools.scripts.JoinSQLScripts" fork="true">
			<arg value="${basedir}/etc/database_operations"/>
			<arg value="${from}"/>
			<arg value="${basedir}/etc/run"/>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="create-test-data"
    		description="Generate sql schema for fenix database."
    		depends="compile">
		<java classname="pt.utl.ist.codeGenerator.database.CreateTestData" fork="true"
				jvmargs="-Xmx1024m -Dfile.encoding=iso8859-1">
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="DmlCleaner" depends="set-properties"
    		description="Generates a single run file for upgrading database.">
		<java classname="pt.utl.ist.codeGenerator.DmlCleaner" fork="true">
			<arg value="${basedir}/build/WEB-INF/classes/domain_model.dml"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="DmlChecker" depends="set-properties"
    		description="Generates a single run file for upgrading database.">
		<java classname="pt.utl.ist.codeGenerator.DmlChecker" fork="true">
			<arg value="${basedir}/build/WEB-INF/classes/domain_model.dml"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="OidSqlGenerator" depends="set-properties"
    		description="Generates a single run file for upgrading database.">
		<java classname="pt.utl.ist.codeGenerator.OidSqlGenerator" fork="true">
			<arg value="${basedir}/web/WEB-INF/classes/domain_model.dml"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${build.home.webinf.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

</project>
