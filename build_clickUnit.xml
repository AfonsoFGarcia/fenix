<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="do-roleback" name="Build file for running ClickUnit tests">

	<property name="encoding" value="ISO-8859-1"/>	

	<property file="build.properties"/>

	<property name="config" location="config"/>
	<property name="lib" location="lib" />

	<property name="build.home" location="build"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>

    <target name="reverse-roleback-file"
    		description="Reverses the contents of the sql file with the roleback instructions.">
		<java classname="net.sourceforge.fenixedu.tools.io.ReverseFile" fork="true">
			<arg value="${roleback.filename}"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
			</classpath>
		</java>
    </target>

	<target name="delete-artifacts"
    		description="Deletes roleback file.">
        <delete file="${roleback.filename}"/>
    </target>

    <target name="do-roleback"
    		depends="reverse-roleback-file"
    		description="Reverts the database state to that of before the test run.">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}"
        	keepformat="true"
            src="${roleback.filename}">
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    	<get src="http://${htttp.host}:${http.port}/${app.name}/manager/manageCache.do?method=clearCache"
    		dest="${roleback.filename}"/>
    	<get src="http://${htttp.host}:${http.port}/${app.name}/manager/manageCache.do?method=clearResponseCache"
    		dest="${roleback.filename}"/>
    	<antcall target="delete-artifacts"/>
    </target>

</project>