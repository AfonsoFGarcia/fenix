<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="deploy-tests" name="fenix">

	<taskdef name="scp" 
					classname="org.apache.tools.ant.taskdefs.optional.ssh.Scp" />

    <taskdef name="sshexec"
             classname="org.apache.tools.ant.taskdefs.optional.ssh.SSHExec" />

    <!-- ########## PROPERTIES ########## -->

    <property environment="env"/>
	<property name="encoding" value="ISO-8859-15"/>


    <!-- ########## TARGETS ########## -->
    <target name="deploy-tests" description="Deploys application to test server">
		<property name="server.hostname"  value="fenix-tests.ist.utl.pt" />
		<property name="server.deployDirectory" value="/var/tomcat4/webapps"/>
		<property name="server.restartCommand"
				  value="apachectl stop; /etc/init.d/tomcat4 restart; apachectl start"
				  />
		<property name="server.startCommand" value="/etc/init.d/tomcat4 start" />
		<property name="server.stopCommand" value="/etc/init.d/tomcat4 stop" />		

		<!-- Prompt for username & password -->
		<input message="Enter username for ${server.hostname}:" addproperty="server.username" />
		<input message="Enter password for ${server.hostname}:" addproperty="server.password" />

		<!-- Obtain propper build.properties -->
		<move file="build.properties" tofile="build.properties_backup" />
		<scp file="${server.username}:${server.password}@${server.hostname}:/root/configs/build_fenix-tests_extra.properties" todir="./"/>
		<move file="build_fenix-tests_extra.properties"  tofile="build.properties" />
	<!--
		<property file="build.properties"/>
	-->
		<antcall target="stop-server"/>
		<!-- Deploy the application-->
		<antcall target="deploy"/>

		<sleep seconds="5"/>

		<delete file="build.properties"/>
		<scp file="${server.username}:${server.password}@${server.hostname}:/root/configs/build_fenix-tests_intra.properties" todir="./"/>

		<move file="build_fenix-tests_intra.properties"  tofile="build.properties"  />

		<!-- Deploy the application-->
		<antcall target="deploy" />

		<antcall target="start-server" />
		<!-- Restore original build.properties -->
		<move file="build.properties_backup" tofile="build.properties" overwrite="true"/>
    </target>


    <target name="deploy-fenix" description="Deploys application into production server">
		<property name="server.hostname" value="fenix.ist.utl.pt"/>
		<property name="server.deployDirectory" value="/opt/jakarta/tomcat/webapps" />

		<property name="server.stopCommand" value="rcapache stop ; rctomcat stop" />
		<property name="server.startCommand" value="rctomcat start; rcapache start" />

		<!-- Prompt for username & password -->
		<input message="Enter username for ${server.hostname}:" addproperty="server.username" />
		<input message="Enter password for ${server.hostname}:"  addproperty="server.password" />

		<!-- Obtain propper build.properties -->
		<move file="build.properties"  tofile="build.properties_backup" />
		<scp file="${server.username}:${server.password}@${server.hostname}:/root/configs/build_fenix.properties" todir="./" 
			/>
		<move file="build_fenix.properties"  tofile="build.properties" />

		<!-- Deploy the application-->
		
		<antcall target="stop-server" />
		<antcall target="deploy"/>
		<antcall target="start-server" />		

		<sleep seconds="5"/>

		<delete file="build.properties"/>

		<scp file="${server.username}:${server.password}@${server.hostname}:/root/configs/build_wwwapl.properties"
			 todir="./" />
		<move file="build_wwwapl.properties"  tofile="build.properties" />
		<sleep seconds="5"/>

		<!-- Deploy the application-->
		<antcall target="deploy-apl"/>

		<!-- Restore original build.properties -->
		<move file="build.properties_backup"  tofile="build.properties"  overwrite="true" />
    </target>


    <target name="deploy" description="Deploys application">
		<property file="build.properties"/>

		<!-- Clean-all -->
        <ant antfile="build.xml" target="clean-all" />

		<!-- Create WAR's -->
        <ant antfile="build.xml" target="deploy-webapp" />

		<!-- Transfer WAR's to server -->
        <scp todir="${server.username}:${server.password}@${server.hostname}:${server.deployDirectory}" file="deploy/${app.name}.war" />

		<!-- Decompress WAR'S -->
		<!-- Delete WAR'S -->
		<!-- Restart Server -->
        <sshexec host="${server.hostname}" username="${server.username}" password="${server.password}"
        		 command="cd ${server.deployDirectory}; rm -rf ${app.name}; unzip ${app.name}.war -d ${app.name} ; rm -f ${app.name}.war" />
		<!-- Clean-all -->
        <ant antfile="build.xml" target="clean-all" />
    </target>

    <target name="deploy-apl" description="Deploys application to WWW.APL">

		<property file="build.properties"/>

		<!-- Clean-all -->
        <ant antfile="build.xml" target="clean-all"/>

		<!-- Create WAR's -->
        <ant antfile="build.xml" target="deploy-webapp" />

		<!-- Transfer WAR's to server -->
        <scp todir="${server.username}:${server.password}@${server.hostname}:/tmp" file="deploy/${app.name}.war"/>

		<sleep seconds="5"/>

		<!-- Decompress WAR'S -->
		<!-- Delete WAR'S -->
		<!-- Restart Server -->
        <sshexec host="${server.hostname}" username="${server.username}" password="${server.password}"
        		 command="cd /root/configs/; ant -f build_deploy_wwwapl.xml" />
		<!-- Clean-all -->
        <ant antfile="build.xml" target="clean-all" />
    </target>
    
	<target name="stop-server">
        <sshexec host="${server.hostname}" username="${server.username}" password="${server.password}"
        				 command="${server.stopCommand}" />
	</target>
	<target name="start-server">
        <sshexec host="${server.hostname}" username="${server.username}" password="${server.password}"
        				 command="${server.startCommand}" />
	</target>
	
</project>
