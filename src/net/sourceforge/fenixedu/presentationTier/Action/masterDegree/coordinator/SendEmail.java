package net.sourceforge.fenixedu.presentationTier.Action.masterDegree.coordinator;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sourceforge.fenixedu.domain.Degree;
import net.sourceforge.fenixedu.domain.DegreeCurricularPlan;
import net.sourceforge.fenixedu.domain.RootDomainObject;
import net.sourceforge.fenixedu.domain.accessControl.CurrentDegreeCoordinatorsGroup;
import net.sourceforge.fenixedu.domain.accessControl.DegreeStudentsGroup;
import net.sourceforge.fenixedu.domain.accessControl.DegreeTeachersGroup;
import net.sourceforge.fenixedu.injectionCode.IGroup;
import net.sourceforge.fenixedu.presentationTier.Action.cms.messaging.mailSender.MailBean;
import net.sourceforge.fenixedu.presentationTier.Action.cms.messaging.mailSender.SimpleMailSenderAction;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

public class SendEmail extends SimpleMailSenderAction {

    public DegreeCurricularPlan getDegreeCurricularPlan(HttpServletRequest request) {
	String parameter = request.getParameter("degreeCurricularPlanID");

	if (parameter == null) {
	    return null;
	}

	try {
	    Integer oid = new Integer(parameter);
	    return RootDomainObject.getInstance().readDegreeCurricularPlanByOID(oid);
	} catch (NumberFormatException e) {
	    return null;
	}
    }

    @Override
    public ActionForward execute(ActionMapping mapping, ActionForm actionForm, HttpServletRequest request,
	    HttpServletResponse response) throws Exception {
	DegreeCurricularPlan degreeCurricularPlan = getDegreeCurricularPlan(request);
	if (degreeCurricularPlan != null) {
	    request.setAttribute("degreeCurricularPlan", degreeCurricularPlan);
	}

	return super.execute(mapping, actionForm, request, response);
    }

    @Override
    protected MailBean createMailBean(HttpServletRequest request) {
	MailBean mailBean = super.createMailBean(request);

	boolean studentsPreselected = request.getParameter("students") != null;
	if (studentsPreselected) {
	    DegreeCurricularPlan degreeCurricularPlan = getDegreeCurricularPlan(request);
	    if (degreeCurricularPlan != null) {
		Degree degree = degreeCurricularPlan.getDegree();

		mailBean.addReceiversGroup(new DegreeStudentsGroup(degree));
	    }
	}

	return mailBean;
    }

    @Override
    protected List<IGroup> getPossibleReceivers(HttpServletRequest request) {
	List<IGroup> groups = super.getPossibleReceivers(request);

	DegreeCurricularPlan degreeCurricularPlan = getDegreeCurricularPlan(request);
	if (degreeCurricularPlan == null) {
	    return groups;
	}

	Degree degree = degreeCurricularPlan.getDegree();
	groups.add(new CurrentDegreeCoordinatorsGroup(degree));
	groups.add(new DegreeTeachersGroup(degree));
	groups.add(new DegreeStudentsGroup(degree));

	return groups;
    }

}
