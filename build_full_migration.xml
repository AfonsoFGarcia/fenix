<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="compile-proj" name="MIGRATION">

	<property name="sshtools.home" location="lib"/>
	<property environment="env"/>
	<property file="build.properties"/>
	<property name="src" location="src"/>
	<property name="build.home" location="build"/>
	<property name="webapp"          location="${build.home}/app"/>
	<property name="webapp.metadata" value="${webapp}/WEB-INF"/>
	<property name="webapp.classes"  value="${webapp.metadata}/classes"/>
	<property name="webapp.lib"      value="${webapp.metadata}/lib"/>
	<property name="lib" location="lib"/>
	<property location="lib_web" name="libs.web"/>
	<property location="config" name="config"/>
	<property location="etc" name="sql"/>
	<property name="compile.debug"       value="on"/>
	<property name="compile.deprecation" value="on"/>
	<property name="compile.optimize"    value="on"/>
	<property name="encoding" value="ISO-8859-15"/>

	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

	<target name="clean-all" description="Removes any generated files">
		<delete dir="${build.home}"/>
	</target>

	<target name="prepare">
		<mkdir dir="${webapp.classes}"/>
		<mkdir dir="${webapp.lib}"/>

		<copy todir="${webapp.metadata}">
			<fileset dir="${basedir}/metadata"/>
		</copy>

		<copy todir="${webapp.lib}">
			<fileset dir="${basedir}/lib">
				<exclude name="servlet.jar"/>
				<exclude name="strutstest.jar"/>
			</fileset>
			<fileset dir="${basedir}/lib_web">
				<exclude name="servlet.jar"/>
				<exclude name="strutstest.jar"/>
			</fileset>
		</copy>

		<copy todir="${webapp.classes}">
			<fileset dir="${basedir}/config"/>
		</copy>
	</target>

	<target name="compile-proj"
            description="Compila o projecto principal" depends="prepare">
		<tstamp/>
		<javac destdir="${webapp.classes}"
               extdirs="${lib};${libs.web}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
               memoryInitialSize="512m"
               memoryMaximumSize="512m"
               fork="yes">
			<src path="${src}"/>
		</javac>
		<replace dir="${webapp.metadata}" propertyFile="build.properties">
			<include name="**/**/*.xml"/>
			<include name="**/**/ApplicationResources.properties"/>
			<include name="**/ServidorPersistenteConfig.properties"/>
			<include name="**/ServidorPersistenteOracleConfig.properties"/>

			<replacefilter token="@db.user@" property="db.user"/>
			<replacefilter token="@db.pass@" property="db.pass"/>
			<replacefilter token="@db.name@" property="db.name"/>
			<replacefilter token="@db.alias@" property="db.alias"/>
		</replace>
	</target>

	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

	<target name="create-tables" description="Cria as tabelas da base de dados.">
		<sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql:${db.alias}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
			<fileset dir="${sql}">
				<include name="middleware/commons/createTables.sql"/>
			</fileset>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="replace-tokens">
		<delete file="${sql}/middleware/commons/PopulateTables_generated.sql"/>
		<copy file="${sql}/middleware/commons/PopulateTables.sql" toFile="${sql}/middleware/commons/PopulateTables_generated.sql"/>
		<replace dir="${sql}/middleware/commons" propertyFile="middleware.properties">
			<include name="PopulateTables_generated.sql"/>
			<replacefilter token="@load.data.infile.root@" property="load.data.infile.root"/>
			<replacefilter token="@load.data.infile.rootIleec@" property="load.data.infile.rootIleec"/>
		</replace>
	</target>

	<target name="load-data-from-old-system" depends="create-tables, replace-tokens" description="Carrega os dados nas tabelas">
		<sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql:${db.alias}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
			<fileset dir="${sql}">
				<include name="middleware/commons/PopulateTables_generated.sql"/>
			</fileset>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="load-new-students">
		<sql
			driver="com.mysql.jdbc.Driver"
			url="jdbc:mysql:${db.alias}"
			userid="${db.user}"
			password="${db.pass}"
			encoding="${encoding}">
			<fileset dir="${sql}">
				<include name="middleware/others/LoadNewStudents.sql"/>
			</fileset>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

	<target name="add-and-update-enrollment-in-past-curriculums" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.RunMigrationProcess" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="addAndUpdateEnrollmentInPastCurriculums 1d0258c2440a8d19e716292b231e3190"/>
		</java>
	</target>

	<target name="add-and-update-enrollment-in-current-curriculums" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.RunMigrationProcess" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="addAndUpdateEnrollmentInCurrentCurriculums 1d0258c2440a8d19e716292b231e3190"/>
		</java>
	</target>

	<target name="migrate-all-current-curriculums" depends="compile-proj">
		<exec executable="${sql}/middleware/commands/migrateAllCurrentCurriculums.sh" os="Linux, Unix">
			<arg value="stop"/>
		</exec>
		<exec executable="${sql}/middleware/commands/migrateAllCurrentCurriculums.bat" vmlauncher="true" os="Windows, Windows 2000, Windows XP">
		</exec>
	</target>

	<target name="migrate-all-past-curriculums" depends="compile-proj">
		<exec executable="${sql}/middleware/commands/migrateAllPastCurriculums.sh" os="Linux, Unix">
			<arg value="stop"/>
		</exec>
		<exec executable="${sql}/middleware/commands/migrateAllPastCurriculums.bat" vmlauncher="true" os="Windows, Windows 2000, Windows XP">
		</exec>
	</target>

	<target name="create-new-students" depends="compile-proj, load-new-students">
		<java classname="middleware.studentMigration.enrollments.RunMigrationProcess" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="createNewStudents"/>
		</java>
	</target>

	<target name="delete-enrollments-no-longer-in-student-curricular-plans" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.RunMigrationProcess" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="deleteAnnulledEnrollmentsInAllCurriculums 1d0258c2440a8d19e716292b231e3190"/>
		</java>
	</target>

	<target name="delete-enrollments-no-longer-in-student-curricular-plans-2" depends="compile-proj">
		<exec executable="${sql}/middleware/commands/deleteEnrollmentsNoLongerInStudentCurricularPlans.sh" os="Linux, Unix">
			<arg value="stop"/>
		</exec>
		<exec executable="${sql}/middleware/commands/deleteEnrollmentsNoLongerInStudentCurricularPlans.bat" vmlauncher="true" os="Windows, Windows 2000, Windows XP">
		</exec>
	</target>

	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
	<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

	<target name="test-delete-enrollments-no-longer-in-student-curricular-plans" depends="compile-proj">
		<java classname="ServidorAplicacao.Servico.manager.migration.withBroker.DeleteEnrollmentsInStudentCurricularPlans" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="test-add-and-update-enrollment-in-past-curriculums" depends="compile-proj">
		<java classname="ServidorAplicacao.Servico.manager.migration.withBroker.AddAndUpdateEnrollmentsInPastStudentCurricularPlans" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="test-add-and-update-enrollment-in-current-curriculums" depends="compile-proj">
		<java classname="ServidorAplicacao.Servico.manager.migration.withBroker.AddAndUpdateEnrollmentsInCurrentStudentCurricularPlans" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="test-create-new-students" depends="compile-proj, load-new-students">
		<java classname="ServidorAplicacao.Servico.manager.migration.withBroker.CreateNewStudents" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="all"
		depends="delete-enrollments-no-longer-in-student-curricular-plans-2,
				 migrate-all-past-curriculums,
				 migrate-all-current-curriculums">
	</target>

	<target name="test-set-enrollments-in-attends" depends="compile-proj">
		<java classname="ServidorAplicacao.Servico.manager.migration.withBroker.SetEnrollmentsInAttends" fork="yes"
			failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

</project>